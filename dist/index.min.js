!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).mlcontour=e()}(this,(function(){"use strict";var t,e,i;function r(r,n){if(t)if(e){var s="var sharedChunk = {}; ("+t+")(sharedChunk); ("+e+")(sharedChunk);",o={};t(o),i=n(o),"undefined"!=typeof window&&(i.workerUrl=window.URL.createObjectURL(new Blob([s],{type:"text/javascript"})))}else e=n;else t=n}return r(0,(function(t){class e{constructor(t,e){this.start=t,this.end=e,this.points=[],this.append=this.append.bind(this),this.prepend=this.prepend.bind(this)}append(t,e){this.points.push(Math.round(t),Math.round(e))}prepend(t,e){this.points.splice(0,0,Math.round(t),Math.round(e))}lineString(){return this.toArray()}isEmpty(){return this.points.length<2}appendFragment(t){this.points.push(...t.points),this.end=t.end}toArray(){return this.points}}const i=[[],[[[1,2],[0,1]]],[[[2,1],[1,2]]],[[[2,1],[0,1]]],[[[1,0],[2,1]]],[[[1,2],[0,1]],[[1,0],[2,1]]],[[[1,0],[1,2]]],[[[1,0],[0,1]]],[[[0,1],[1,0]]],[[[1,2],[1,0]]],[[[0,1],[1,0]],[[2,1],[1,2]]],[[[2,1],[1,0]]],[[[0,1],[2,1]]],[[[1,2],[2,1]]],[[[0,1],[1,2]]],[]];function r(t,e,i,r){return(e=2*e+r[0])+(i=2*i+r[1])*(t+1)*2}function n(t,e,i){return(e-t)/(i-t)}function s(t,s,o=4096,a=1){if(!t)return{};const h=o/(s.width-1);let l,u,c,f,d,p;const w={},g=new Map,m=new Map;function v(t,e,i){0===t[0]?i(h*(p-1),h*(d-n(c,e,l))):2===t[0]?i(h*p,h*(d-n(f,e,u))):0===t[1]?i(h*(p-n(u,e,l)),h*(d-1)):i(h*(p-n(f,e,c)),h*d)}for(d=1-a;d<s.height+a;d++){u=s.get(0,d-1),f=s.get(0,d);let n=Math.min(u,f),o=Math.max(u,f);for(p=1-a;p<s.width+a;p++){l=u,c=f,u=s.get(p,d-1),f=s.get(p,d);const a=n,h=o;if(n=Math.min(u,f),o=Math.max(u,f),isNaN(l)||isNaN(u)||isNaN(f)||isNaN(c))continue;const b=Math.min(a,n),y=Math.max(h,o),x=Math.ceil(b/t)*t,F=Math.floor(y/t)*t;for(let n=x;n<=F;n+=t){const t=l>n,o=u>n,a=c>n,h=f>n;for(const l of i[(t?8:0)|(o?4:0)|(h?2:0)|(a?1:0)]){let t=g.get(n);t||g.set(n,t=new Map);let i=m.get(n);i||m.set(n,i=new Map);const o=l[0],a=l[1],h=r(s.width,p,d,o),u=r(s.width,p,d,a);let c,f;if(c=i.get(h))if(i.delete(h),f=t.get(u))if(t.delete(u),c===f){if(v(a,n,c.append),!c.isEmpty()){let t=w[n];t||(w[n]=t=[]),t.push(c.lineString())}}else c.appendFragment(f),i.set(c.end=f.end,c);else v(a,n,c.append),i.set(c.end=u,c);else if(c=t.get(u))t.delete(u),v(o,n,c.prepend),t.set(c.start=h,c);else{const r=new e(h,u);v(o,n,r.append),v(a,n,r.append),t.set(h,r),i.set(u,r)}}}}}for(const[t,e]of g.entries()){let i=null;for(const r of e.values())r.isEmpty()||(null==i&&(i=w[t]||(w[t]=[])),i.push(r.lineString()))}return w}
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */function o(t,e){var i={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(i[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(t);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(t,r[n])&&(i[r[n]]=t[r[n]])}return i}function a(t,e,i,r){return new(i||(i=Promise))((function(n,s){function o(t){try{h(r.next(t))}catch(t){s(t)}}function a(t){try{h(r.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((r=r.apply(t,e||[])).next())}))}function h(t){const e=Object.entries(t);return e.sort((([t],[e])=>t<e?-1:t>e?1:0)),e}function l(t){return h(t).map((([t,e])=>[t,..."number"==typeof e?[e]:e].join("*"))).join("~")}function u(t){return h(t).map((([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join(",")}let c=null;function f(){return null==c&&(c="undefined"!=typeof OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof createImageBitmap),c||!1}let d=null;function p(t,e,i){let r=()=>{};const n=setTimeout((()=>{r(new Error("timed out")),null==i||i.abort()}),t);w(i,(()=>{r(new Error("aborted")),clearTimeout(n)}));const s=new Promise(((t,e)=>{r=e}));return Promise.race([s,e.finally((()=>clearTimeout(n)))])}function w(t,e){e&&(null==t||t.signal.addEventListener("abort",e))}function g(t){var e;return Boolean(null===(e=null==t?void 0:t.signal)||void 0===e?void 0:e.aborted)}let m,v,b,y,x=0;class F{constructor(t=100){this.size=()=>this.items.size,this.get=(t,e,i)=>{let r=this.items.get(t);if(r)r.lastUsed=++x,r.waiting++;else{const i=new AbortController,n=e(t,i);r={abortController:i,item:n,lastUsed:++x,waiting:1},this.items.set(t,r),this.prune()}const n=this.items,s=r.item.then((t=>t),(e=>(n.delete(t),Promise.reject(e))));let o=!1;return w(i,(()=>{var e;r&&r.abortController&&!o&&(o=!0,--r.waiting<=0&&(null===(e=r.abortController)||void 0===e||e.abort(),n.delete(t)))})),s},this.clear=()=>this.items.clear(),this.maxSize=t,this.items=new Map}prune(){if(this.items.size>this.maxSize){let t,e=1/0;this.items.forEach(((i,r)=>{i.lastUsed<e&&(e=i.lastUsed,t=r)})),void 0!==t&&this.items.delete(t)}}}function M(t,e){return m||(m=new OffscreenCanvas(t.width,t.height),v=m.getContext("2d",{willReadFrequently:!0})),k(t,e,m,v)}const P=function(){if(null==d&&(d=!1,f()&&"undefined"!=typeof VideoFrame)){const t=5,e=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(e){for(let i=0;i<t*t;i++){const r=4*i;e.fillStyle=`rgb(${r},${r+1},${r+2})`,e.fillRect(i%t,Math.floor(i/t),1,1)}const i=e.getImageData(0,0,t,t).data;for(let e=0;e<t*t*4;e++)if(e%4!=3&&i[e]!==e){d=!0;break}}}return d||!1}()?function(t,e,i){return a(this,void 0,void 0,(function*(){var r,n,s;const o=yield createImageBitmap(t);if(g(i))return null;const a=new VideoFrame(o,{timestamp:0});try{if(!((null===(r=null==a?void 0:a.format)||void 0===r?void 0:r.startsWith("BGR"))||(null===(n=null==a?void 0:a.format)||void 0===n?void 0:n.startsWith("RGB"))))throw new Error(`Unrecognized format: ${null==a?void 0:a.format}`);const t=null===(s=null==a?void 0:a.format)||void 0===s?void 0:s.startsWith("BGR"),i=a.allocationSize(),h=new Uint8ClampedArray(i);if(yield a.copyTo(h),t)for(let t=0;t<h.length;t+=4){const e=h[t];h[t]=h[t+2],h[t+2]=e}return S(o.width,o.height,e,h)}catch(t){return g(i)?null:M(o,e)}finally{a.close()}}))}:f()?function(t,e,i){return a(this,void 0,void 0,(function*(){const r=yield createImageBitmap(t);return g(i)?null:M(r,e)}))}:"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope?function(t,e,i){return self.actor.send("decodeImage",[],i,void 0,t,e)}:function(t,e,i){return a(this,void 0,void 0,(function*(){b||(b=document.createElement("canvas"),y=b.getContext("2d",{willReadFrequently:!0}));const r=new Image;w(i,(()=>r.src=""));return k(yield new Promise(((e,n)=>{r.onload=()=>{g(i)||e(r),URL.revokeObjectURL(r.src),r.onload=null},r.onerror=()=>n(new Error("Could not load image.")),r.src=t.size?URL.createObjectURL(t):""})),e,b,y)}))};function k(t,e,i,r){if(i.width=t.width,i.height=t.height,!r)throw new Error("failed to get context");r.drawImage(t,0,0,t.width,t.height);const n=r.getImageData(0,0,t.width,t.height).data;return S(t.width,t.height,e,n)}function S(t,e,i,r){const n=(t=>"mapbox"===t?(t,e,i)=>.1*(256*t*256+256*e+i)-1e4:"gsj"===t?(t,e,i)=>{const r=256*t*256+256*e+i;return r===2**23?0:r>2**23?.01*(r-2**24):.01*r}:(t,e,i)=>256*t+e+i/256-32768)(i),s=new Float32Array(t*e);for(let t=0;t<r.length;t+=4)s[t/4]=n(r[t],r[t+1],r[t+2]);return{width:t,height:e,data:s}}class N{constructor(t,e,i){this.split=(t,e,i)=>{if(0===t)return this;const r=1<<t,n=e*this.width/r,s=i*this.height/r;return new N(this.width/r,this.height/r,((t,e)=>this.get(t+n,e+s)))},this.subsamplePixelCenters=t=>{const e=(t,e,i)=>isNaN(t)?e:isNaN(e)?t:t+(e-t)*i;if(t<=1)return this;const i=.5-1/(2*t);return new N(this.width*t,this.height*t,((r,n)=>{const s=r/t-i,o=n/t-i,a=Math.floor(s),h=Math.floor(o),l=this.get(a,h),u=this.get(a+1,h),c=this.get(a,h+1),f=this.get(a+1,h+1),d=s-a,p=o-h,w=e(l,u,d),g=e(c,f,d);return e(w,g,p)}))},this.averagePixelCentersToGrid=(t=1)=>new N(this.width+1,this.height+1,((e,i)=>{let r=0,n=0,s=0;for(let o=e-t;o<e+t;o++)for(let e=i-t;e<i+t;e++)isNaN(s=this.get(o,e))||(n++,r+=s);return 0===n?NaN:r/n})),this.scaleElevation=t=>1===t?this:new N(this.width,this.height,((e,i)=>this.get(e,i)*t)),this.materialize=(t=2)=>{const e=this.width+2*t,i=new Float32Array(e*(this.height+2*t));let r=0;for(let e=-t;e<this.height+t;e++)for(let n=-t;n<this.width+t;n++)i[r++]=this.get(n,e);return new N(this.width,this.height,((r,n)=>i[(n+t)*e+r+t]))},this.get=i,this.width=t,this.height=e}static fromRawDem(t){return new N(t.width,t.height,((e,i)=>{const r=t.data[i*t.width+e];return n=r,!isNaN(n)&&n>=-12e3&&n<=9e3?r:NaN;var n}))}static combineNeighbors(t){if(9!==t.length)throw new Error("Must include a tile plus 8 neighbors");const e=t[4];if(!e)return;const i=e.width,r=e.height;return new N(i,r,((e,n)=>{let s=0;n<0?n+=r:n<r?s+=3:(n-=r,s+=6),e<0?e+=i:e<i?s+=1:(e-=i,s+=2);const o=t[s];return o?o.get(e,n):NaN}))}}function T(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var B={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(t,e,i,r,n){var s,o,a=8*n-r-1,h=(1<<a)-1,l=h>>1,u=-7,c=i?n-1:0,f=i?-1:1,d=t[e+c];for(c+=f,s=d&(1<<-u)-1,d>>=-u,u+=a;u>0;s=256*s+t[e+c],c+=f,u-=8);for(o=s&(1<<-u)-1,s>>=-u,u+=r;u>0;o=256*o+t[e+c],c+=f,u-=8);if(0===s)s=1-l;else{if(s===h)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,r),s-=l}return(d?-1:1)*o*Math.pow(2,s-r)},write:function(t,e,i,r,n,s){var o,a,h,l=8*s-n-1,u=(1<<l)-1,c=u>>1,f=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,p=r?1:-1,w=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=u):(o=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-o))<1&&(o--,h*=2),(e+=o+c>=1?f/h:f*Math.pow(2,1-c))*h>=2&&(o++,h/=2),o+c>=u?(a=0,o=u):o+c>=1?(a=(e*h-1)*Math.pow(2,n),o+=c):(a=e*Math.pow(2,c-1)*Math.pow(2,n),o=0));n>=8;t[i+d]=255&a,d+=p,a/=256,n-=8);for(o=o<<n|a,l+=n;l>0;t[i+d]=255&o,d+=p,o/=256,l-=8);t[i+d-p]|=128*w}},V=O,C=B;function O(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}O.Varint=0,O.Fixed64=1,O.Bytes=2,O.Fixed32=5;var U=4294967296,I=1/U,E="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function A(t){return t.type===O.Bytes?t.readVarint()+t.pos:t.pos+1}function D(t,e,i){return i?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function j(t,e,i){var r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(r);for(var n=i.pos-1;n>=t;n--)i.buf[n+r]=i.buf[n]}function z(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function R(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function L(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function $(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function G(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function W(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function _(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function q(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function K(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function Y(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function H(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function J(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}O.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var r=this.readVarint(),n=r>>3,s=this.pos;this.type=7&r,t(n,e,this),this.pos===s&&this.skip(r)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Y(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=J(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Y(this.buf,this.pos)+Y(this.buf,this.pos+4)*U;return this.pos+=8,t},readSFixed64:function(){var t=Y(this.buf,this.pos)+J(this.buf,this.pos+4)*U;return this.pos+=8,t},readFloat:function(){var t=C.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=C.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,i,r=this.buf;return e=127&(i=r[this.pos++]),i<128?e:(e|=(127&(i=r[this.pos++]))<<7,i<128?e:(e|=(127&(i=r[this.pos++]))<<14,i<128?e:(e|=(127&(i=r[this.pos++]))<<21,i<128?e:function(t,e,i){var r,n,s=i.buf;if(n=s[i.pos++],r=(112&n)>>4,n<128)return D(t,r,e);if(n=s[i.pos++],r|=(127&n)<<3,n<128)return D(t,r,e);if(n=s[i.pos++],r|=(127&n)<<10,n<128)return D(t,r,e);if(n=s[i.pos++],r|=(127&n)<<17,n<128)return D(t,r,e);if(n=s[i.pos++],r|=(127&n)<<24,n<128)return D(t,r,e);if(n=s[i.pos++],r|=(1&n)<<31,n<128)return D(t,r,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(i=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&E?function(t,e,i){return E.decode(t.subarray(e,i))}(this.buf,e,t):function(t,e,i){var r="",n=e;for(;n<i;){var s,o,a,h=t[n],l=null,u=h>239?4:h>223?3:h>191?2:1;if(n+u>i)break;1===u?h<128&&(l=h):2===u?128==(192&(s=t[n+1]))&&(l=(31&h)<<6|63&s)<=127&&(l=null):3===u?(s=t[n+1],o=t[n+2],128==(192&s)&&128==(192&o)&&((l=(15&h)<<12|(63&s)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===u&&(s=t[n+1],o=t[n+2],a=t[n+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&((l=(15&h)<<18|(63&s)<<12|(63&o)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,u=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),r+=String.fromCharCode(l),n+=u}return r}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==O.Bytes)return t.push(this.readVarint(e));var i=A(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==O.Bytes)return t.push(this.readSVarint());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==O.Bytes)return t.push(this.readBoolean());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==O.Bytes)return t.push(this.readFloat());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==O.Bytes)return t.push(this.readDouble());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==O.Bytes)return t.push(this.readFixed32());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==O.Bytes)return t.push(this.readSFixed32());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==O.Bytes)return t.push(this.readFixed64());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==O.Bytes)return t.push(this.readSFixed64());var e=A(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===O.Varint)for(;this.buf[this.pos++]>127;);else if(e===O.Bytes)this.pos=this.readVarint()+this.pos;else if(e===O.Fixed32)this.pos+=4;else{if(e!==O.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),H(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),H(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),H(this.buf,-1&t,this.pos),H(this.buf,Math.floor(t*I),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),H(this.buf,-1&t,this.pos),H(this.buf,Math.floor(t*I),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var i,r;t>=0?(i=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(i=~(-t%4294967296))?i=i+1|0:(i=0,r=r+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,i){i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos]=127&t}(i,0,e),function(t,e){var i=(7&t)<<4;if(e.buf[e.pos++]|=i|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(r,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,i){for(var r,n,s=0;s<e.length;s++){if((r=e.charCodeAt(s))>55295&&r<57344){if(!n){r>56319||s+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):n=r;continue}if(r<56320){t[i++]=239,t[i++]=191,t[i++]=189,n=r;continue}r=n-55296<<10|r-56320|65536,n=null}else n&&(t[i++]=239,t[i++]=191,t[i++]=189,n=null);r<128?t[i++]=r:(r<2048?t[i++]=r>>6|192:(r<65536?t[i++]=r>>12|224:(t[i++]=r>>18|240,t[i++]=r>>12&63|128),t[i++]=r>>6&63|128),t[i++]=63&r|128)}return i}(this.buf,t,this.pos);var i=this.pos-e;i>=128&&j(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),C.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),C.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var r=this.pos-i;r>=128&&j(i,r,this),this.pos=i-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,e,i){this.writeTag(t,O.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,z,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,R,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,G,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,L,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,$,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,W,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,_,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,q,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,K,e)},writeBytesField:function(t,e){this.writeTag(t,O.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,O.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,O.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,O.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,O.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,O.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,O.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,O.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,O.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,O.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};var Q,X=T(V);function Z(t,e){if(!e)throw new Error("pbf undefined");e.writeVarintField(15,2),e.writeStringField(1,t.id||""),e.writeVarintField(5,t.extent||4096);const i={keys:[],values:[],keycache:{},valuecache:{}};for(const r of t.features)i.feature=r,e.writeMessage(2,tt,i);for(const t of i.keys)e.writeStringField(3,t);for(const t of i.values)e.writeMessage(4,st,t)}function tt(t,e){const i=t.feature;if(!i||!e)throw new Error;e.writeMessage(2,et,t),e.writeVarintField(3,i.type),e.writeMessage(4,nt,i)}function et(t,e){const i=t.feature;if(!i||!e)throw new Error;const r=t.keys,n=t.values,s=t.keycache,o=t.valuecache;for(const t in i.properties){let a=i.properties[t],h=s[t];if(null===a)continue;void 0===h&&(r.push(t),h=r.length-1,s[t]=h),e.writeVarint(h);const l=typeof a;"string"!==l&&"boolean"!==l&&"number"!==l&&(a=JSON.stringify(a));const u=`${l}:${a}`;let c=o[u];void 0===c&&(n.push(a),c=n.length-1,o[u]=c),e.writeVarint(c)}}function it(t,e){return(e<<3)+(7&t)}function rt(t){return t<<1^t>>31}function nt(t,e){if(!e)throw new Error;const i=t.geometry,r=t.type;let n=0,s=0;for(const t of i){let i=1;r===Q.POINT&&(i=t.length/2),e.writeVarint(it(1,i));const o=t.length/2,a=r===Q.POLYGON?o-1:o;for(let i=0;i<a;i++){1===i&&1!==r&&e.writeVarint(it(2,a-1));const o=t[2*i]-n,h=t[2*i+1]-s;e.writeVarint(rt(o)),e.writeVarint(rt(h)),n+=o,s+=h}r===Q.POLYGON&&e.writeVarint(it(7,1))}}function st(t,e){if(!e)throw new Error;"string"==typeof t?e.writeStringField(1,t):"boolean"==typeof t?e.writeBooleanField(7,t):"number"==typeof t&&(t%1!=0?e.writeDoubleField(3,t):t<0?e.writeSVarintField(6,t):e.writeVarintField(5,t))}!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.POINT=1]="POINT",t[t.LINESTRING=2]="LINESTRING",t[t.POLYGON=3]="POLYGON"}(Q||(Q={}));const ot="undefined"!=typeof performance?performance:void 0,at=ot?ot.timeOrigin||(new Date).getTime()-ot.now():(new Date).getTime();function ht(t){var e;return JSON.parse(JSON.stringify((null===(e=null==ot?void 0:ot.getEntriesByName)||void 0===e?void 0:e.call(ot,t))||[]))}function lt(){return ot?ot.now():(new Date).getTime()}function ut(t){const e=[];for(const i of t)e.push(...i);return e}class ct{constructor(t){this.marks={},this.urls=[],this.fetched=[],this.resources=[],this.tilesFetched=0,this.timeOrigin=at,this.finish=t=>{this.markFinish();const e=t=>{const e=this.marks[t]||[],i=Math.max(...e.map((t=>Math.max(...t)))),r=Math.min(...e.map((t=>Math.min(...t))));return Number.isFinite(i)?i-r:void 0},i=e("main")||0,r=e("fetch"),n=e("decode"),s=e("isoline");return{url:t,tilesUsed:this.tilesFetched,origin:this.timeOrigin,marks:this.marks,resources:[...this.resources,...ut(this.fetched.map(ht))],duration:i,fetch:r,decode:n,process:s,wait:i-(r||0)-(n||0)-(s||0)}},this.error=t=>Object.assign(Object.assign({},this.finish(t)),{error:!0}),this.marker=t=>{var e;this.marks[t]||(this.marks[t]=[]);const i=[lt()];return null===(e=this.marks[t])||void 0===e||e.push(i),()=>i.push(lt())},this.useTile=t=>{this.urls.indexOf(t)<0&&(this.urls.push(t),this.tilesFetched++)},this.fetchTile=t=>{this.fetched.indexOf(t)<0&&this.fetched.push(t)},this.addAll=t=>{var e;this.tilesFetched+=t.tilesUsed;const i=t.origin-this.timeOrigin;for(const r in t.marks){const n=r;(this.marks[n]||(this.marks[n]=[])).push(...(null===(e=t.marks[n])||void 0===e?void 0:e.map((t=>t.map((t=>t+i)))))||[])}this.resources.push(...t.resources.map((t=>function(t,e){const i={};for(const r in t)0!==t[r]&&ft.test(r)?i[r]=Number(t[r])+e:i[r]=t[r];return i}(t,i))))},this.markFinish=this.marker(t)}}const ft=/(Start$|End$|^start|^end)/;let dt=0;t.A=class{constructor(t,e,i=2e4){this.callbacks={},this.cancels={},this.dest=t,this.timeoutMs=i,this.dest.onmessage=t=>a(this,[t],void 0,(function*({data:t}){const i=t;if("cancel"===i.type){const t=this.cancels[i.id];delete this.cancels[i.id],null==t||t.abort()}else if("response"===i.type){const t=this.callbacks[i.id];delete this.callbacks[i.id],t&&t(i.error?new Error(i.error):void 0,i.response,i.timings)}else if("request"===i.type){const t=new ct("worker"),r=e[i.name],n=new AbortController,s=r.apply(r,[...i.args,n,t]),o=`${i.name}_${i.id}`;if(i.id&&s){this.cancels[i.id]=n;try{const e=yield s,r=null==e?void 0:e.transferrables;this.postMessage({id:i.id,type:"response",response:e,timings:t.finish(o)},r)}catch(e){this.postMessage({id:i.id,type:"response",error:(null==e?void 0:e.toString())||"error",timings:t.finish(o)})}delete this.cancels[i.id]}}}))}postMessage(t,e){this.dest.postMessage(t,e||[])}send(t,e,i,r,...n){const s=++dt,o=new Promise(((i,o)=>{this.postMessage({id:s,type:"request",name:t,args:n},e),this.callbacks[s]=(t,e,n)=>{null==r||r.addAll(n),t?o(t):i(e)}}));return w(i,(()=>{delete this.callbacks[s],this.postMessage({id:s,type:"cancel"})})),p(this.timeoutMs,o,i)}},t.H=N,t.L=class{constructor(t,e,i,r,n){this.loaded=Promise.resolve(),this.decodeImage=P,this.fetchAndParseTile=(t,e,i,r,n)=>{const s=this,o=this.demUrlPattern.replace("{z}",t.toString()).replace("{x}",e.toString()).replace("{y}",i.toString());return null==n||n.useTile(o),this.parsedCache.get(o,((r,o)=>a(this,void 0,void 0,(function*(){const r=yield s.fetchTile(t,e,i,o,n);if(g(o))throw new Error("canceled");const a=s.decodeImage(r.data,s.encoding,o),h=null==n?void 0:n.marker("decode"),l=yield a;return null==h||h(),l}))),r)},this.tileCache=new F(e),this.parsedCache=new F(e),this.contourCache=new F(e),this.timeoutMs=n,this.demUrlPattern=t,this.encoding=i,this.maxzoom=r}fetchTile(t,e,i,r,n){const s=this.demUrlPattern.replace("{z}",t.toString()).replace("{x}",e.toString()).replace("{y}",i.toString());return null==n||n.useTile(s),this.tileCache.get(s,((t,e)=>{const i={signal:e.signal};null==n||n.fetchTile(s);const r=null==n?void 0:n.marker("fetch");return p(this.timeoutMs,fetch(s,i).then((t=>a(this,void 0,void 0,(function*(){if(null==r||r(),!t.ok)throw new Error(`Bad response: ${t.status} for ${s}`);return{data:yield t.blob(),expires:t.headers.get("expires")||void 0,cacheControl:t.headers.get("cache-control")||void 0}})))),e)}),r)}fetchDem(t,e,i,r,n,s){return a(this,void 0,void 0,(function*(){const o=Math.min(t-(r.overzoom||0),this.maxzoom),a=t-o,h=1<<a,l=Math.floor(e/h),u=Math.floor(i/h),c=yield this.fetchAndParseTile(o,l,u,n,s);return N.fromRawDem(c).split(a,e%h,i%h)}))}fetchContourTile(t,e,i,r,n,o){const{levels:h,multiplier:l=1,buffer:c=1,extent:f=4096,contourLayer:d="contours",elevationKey:p="ele",levelKey:w="level",subsampleBelow:m=100}=r;if(!h||0===h.length)return Promise.resolve({arrayBuffer:new ArrayBuffer(0)});const v=[t,e,i,u(r)].join("/");return this.contourCache.get(v,((n,u)=>a(this,void 0,void 0,(function*(){const n=1<<t,a=[];for(let s=i-1;s<=i+1;s++)for(let i=e-1;i<=e+1;i++)a.push(s<0||s>=n?void 0:this.fetchDem(t,(i+n)%n,s,r,u,o));const v=yield Promise.all(a);let b=N.combineNeighbors(v);if(!b||g(u))return{arrayBuffer:(new Uint8Array).buffer};const y=null==o?void 0:o.marker("isoline");if(b.width>=m)b=b.materialize(2);else for(;b.width<m;)b=b.subsamplePixelCenters(2).materialize(2);b=b.averagePixelCentersToGrid().scaleElevation(l).materialize(1);const x=s(h[0],b,f,c);null==y||y();const F=function(t){const e=new X;for(const i in t.layers){const r=t.layers[i];r.extent||(r.extent=t.extent),e.writeMessage(3,Z,Object.assign(Object.assign({},r),{id:i}))}return e.finish()}({extent:f,layers:{[d]:{features:Object.entries(x).map((([t,e])=>{const i=Number(t);return{type:Q.LINESTRING,geometry:e,properties:{[p]:i,[w]:Math.max(...h.map(((t,e)=>i%t==0?e:0)))}}}))}}});return null==y||y(),{arrayBuffer:F.buffer}}))),n)}},t.T=ct,t._=a,t.a=function(t){return Object.fromEntries(t.replace(/^.*\?/,"").split("&").map((t=>{const e=t.split("=").map(decodeURIComponent),i=e[0];let r=e[1];switch(i){case"thresholds":n=r,r=Object.fromEntries(n.split("~").map((t=>t.split("*").map(Number))).map((([t,...e])=>[t,e])));break;case"extent":case"multiplier":case"overzoom":case"buffer":r=Number(r)}var n;return[i,r]})))},t.b=s,t.c=S,t.d=P,t.e=function(t){var{thresholds:e}=t,i=o(t,["thresholds"]);return h(Object.assign({thresholds:l(e)},i)).map((([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join("&")},t.f=function(t){return t.then((({arrayBuffer:t})=>{const e=function(t){const e=new ArrayBuffer(t.byteLength);return new Uint8Array(e).set(new Uint8Array(t)),e}(t);return{arrayBuffer:e,transferrables:[e]}}))},t.g=function(t,e){const{thresholds:i}=t,r=o(t,["thresholds"]);let n=[],s=-1/0;return Object.entries(i).forEach((([t,i])=>{const r=Number(t);r<=e&&r>s&&(s=r,n="number"==typeof i?[i]:i)})),Object.assign({levels:n},r)},t.p=function(t,e){return t.then((t=>{var{data:i}=t,r=o(t,["data"]);let n=i;return e&&(n=new Float32Array(i.length),n.set(i)),Object.assign(Object.assign({},r),{data:n,transferrables:[n.buffer]})}))}})),r(0,(function(t){const e=t=>Promise.reject(new Error(`No manager registered for ${t}`));const i="undefined"!=typeof self?self:"undefined"!=typeof window?window:global;i.actor=new t.A(i,new class{constructor(){this.managers={},this.init=(e,i)=>(this.managers[e.managerId]=new t.L(e.demUrlPattern,e.cacheSize,e.encoding,e.maxzoom,e.timeoutMs),Promise.resolve()),this.fetchTile=(t,i,r,n,s,o)=>{var a;return(null===(a=this.managers[t])||void 0===a?void 0:a.fetchTile(i,r,n,s,o))||e(t)},this.fetchAndParseTile=(i,r,n,s,o,a)=>{var h;return t.p((null===(h=this.managers[i])||void 0===h?void 0:h.fetchAndParseTile(r,n,s,o,a))||e(i),!0)},this.fetchContourTile=(i,r,n,s,o,a,h)=>{var l;return t.f((null===(l=this.managers[i])||void 0===l?void 0:l.fetchContourTile(r,n,s,o,a,h))||e(i))}}})})),r(0,(function(t){const e={workerUrl:""};let i,r=0;class n{constructor(){this.decodeImage=(e,i,r)=>t.p(t.d(e,i,r),!1)}}function s(){if(!i){const r=new Worker(e.workerUrl),s=new n;i=new t.A(r,s)}return i}class o{constructor(t,e,i,n,o,a){this.fetchTile=(t,e,i,r,n)=>this.actor.send("fetchTile",[],r,n,this.managerId,t,e,i),this.fetchAndParseTile=(t,e,i,r,n)=>this.actor.send("fetchAndParseTile",[],r,n,this.managerId,t,e,i),this.fetchContourTile=(t,e,i,r,n,s)=>this.actor.send("fetchContourTile",[],n,s,this.managerId,t,e,i,r);const h=this.managerId=++r;this.actor=a||s(),this.loaded=this.actor.send("init",[],new AbortController,void 0,{cacheSize:e,demUrlPattern:t,encoding:i,maxzoom:n,managerId:h,timeoutMs:o})}}Blob.prototype.arrayBuffer||(Blob.prototype.arrayBuffer=function(){return new Promise(((t,e)=>{const i=new FileReader;i.onload=e=>{var i;return t(null===(i=e.target)||void 0===i?void 0:i.result)},i.onerror=e,i.readAsArrayBuffer(this)}))});const a=t=>(e,i)=>{if(i instanceof AbortController)return t(e,i);{const r=new AbortController;return t(e,r).then((t=>i(void 0,t.data,t.cacheControl,t.expires)),(t=>i(t))).catch((t=>i(t))),{cancel:()=>r.abort()}}},h=new Set;const l={generateIsolines:t.b,DemSource:class{constructor({url:e,cacheSize:i=100,id:r="dem",encoding:n="terrarium",maxzoom:s=12,worker:l=!0,timeoutMs:u=1e4,actor:c}){this.timingCallbacks=[],this.onTiming=t=>{this.timingCallbacks.push(t)},this.setupMaplibre=t=>{t.addProtocol(this.sharedDemProtocolId,this.sharedDemProtocol),t.addProtocol(this.contourProtocolId,this.contourProtocol)},this.sharedDemProtocolV4=(e,i)=>t._(this,void 0,void 0,(function*(){const[r,n,s]=this.parseUrl(e.url),o=new t.T("main");let a;try{const t=yield this.manager.fetchTile(r,n,s,i,o);a=o.finish(e.url);return{data:yield t.data.arrayBuffer(),cacheControl:t.cacheControl,expires:t.expires}}catch(t){throw a=o.error(e.url),t}finally{this.timingCallbacks.forEach((t=>t(a)))}})),this.contourProtocolV4=(e,i)=>t._(this,void 0,void 0,(function*(){const r=new t.T("main");let n;try{const[s,o,a]=this.parseUrl(e.url),h=t.a(e.url),l=yield this.manager.fetchContourTile(s,o,a,t.g(h,s),i,r);return n=r.finish(e.url),{data:l.arrayBuffer}}catch(t){throw n=r.error(e.url),t}finally{this.timingCallbacks.forEach((t=>t(n)))}})),this.contourProtocol=a(this.contourProtocolV4),this.sharedDemProtocol=a(this.sharedDemProtocolV4),this.contourProtocolUrl=e=>`${this.contourProtocolUrlBase}?${t.e(e)}`;let f=r,d=1;for(;h.has(f);)f=r+d++;h.add(f),this.sharedDemProtocolId=`${f}-shared`,this.contourProtocolId=`${f}-contour`,this.sharedDemProtocolUrl=`${this.sharedDemProtocolId}://{z}/{x}/{y}`,this.contourProtocolUrlBase=`${this.contourProtocolId}://{z}/{x}/{y}`;const p=l?o:t.L;this.manager=new p(e,i,n,s,u,c)}getDemTile(t,e,i,r){return this.manager.fetchAndParseTile(t,e,i,r||new AbortController)}parseUrl(t){const[,e,i,r]=/\/\/(\d+)\/(\d+)\/(\d+)/.exec(t)||[];return[Number(e),Number(i),Number(r)]}},HeightTile:t.H,LocalDemManager:t.L,decodeParsedImage:t.c,set workerUrl(t){e.workerUrl=t},get workerUrl(){return e.workerUrl}};return l})),i}));
